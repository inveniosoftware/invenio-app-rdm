{#
  Copyright (C) 2020 CERN.
  Copyright (C) 2020 Northwestern University.
  Copyright (C) 2021 New York University.
  Copyright (C) 2023 Front Matter.

  Invenio App RDM is free software; you can redistribute it and/or modify
  it under the terms of the MIT License; see LICENSE file for more details.
#}

{%- from "invenio_formatter/templates/semantic-ui/invenio_formatter/macros/meta.html" import meta_twittercard, meta_opengraph, meta_highwire -%}
{%- set meta_title = record.title|striptags -%}
{%- set meta_description = record.description|striptags -%}
{%- set meta_url = url_for('invenio_records_ui.recid', pid_value=pid.pid_value, _external=True) -%}
{%- set meta_authors = record.creators|map(attribute='name') -%}
{%- set meta_publication_date = record.publication_date|from_isodate -%}
{%- set files = record.files if current_user|has_record_perm(record, 'read-files') else [] %}

{%- if files | selectattr("type", "equalto", "pdf") | list | length is equalto 0 %}
  {% set pdf_url_meta_highwire = "" %}
{%- else %}
  {% set pdf_url_meta_highwire = url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value, filename=files | selectattr("type", "equalto", "pdf") | first | attr("key"), _external=True) %}
{%- endif %}

{{- meta_highwire(
  meta_title,
  meta_description,
  authors=meta_authors,
  publisher=meta_publisher,
  publication_date=publication_date,
  doi=record.doi,
  keywords=record.keywords,
  url=meta_url,
  pdf_url=pdf_url_meta_highwire
) }}
{{- meta_opengraph(meta_title, meta_description, url=meta_url, site_name=meta_site_name) }}
{{- meta_twittercard(meta_title, meta_description, card=meta_card, site=meta_site) }}
    <link rel="canonical" href="{{ meta_url }}">

{%- for file in files or [] -%}
    {%- set file_url = url_for('invenio_records_ui.recid_files', pid_value=pid.pid_value, filename=file.key, _external=True) %}
    <link rel="alternate" type="{{file.mimetype}}" href="{{ file_url }}">
{%- endfor -%}

{%- block javascript %}
{%- block record_jsonld %}
{% set jsonld_serialization = record | transform_record(pid, 'schemaorg_jsonld', throws=False)%}
{%- if jsonld_serialization %}
  <script type='application/ld+json'>{{ jsonld_serialization | tojson }}</script>
{%- endif %}
{%- endblock record_jsonld %}
{%- endblock javascript %}
